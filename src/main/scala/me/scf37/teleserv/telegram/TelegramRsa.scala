package me.scf37.teleserv.telegram

import java.security.KeyFactory
import java.security.MessageDigest
import java.security.PrivateKey
import java.security.PublicKey
import java.security.spec.PKCS8EncodedKeySpec
import java.security.spec.RSAPublicKeySpec

import scodec.bits.BitVector
import scodec.bits.ByteVector

/**
  * RSA key to use with telegram server
  *
  */
case class TelegramRsa(
  publicKeyMod: Array[Byte],
  publicKeyExp: Array[Byte],
  privateKeyBytes: Array[Byte]
) {
  /** RSA public key fingerprint as per telegram spec */
  val fingerprint: Long = {
    val encodedKey = TString.codec.encode(TString(ByteVector(publicKeyMod))).require ++
      TString.codec.encode(TString(ByteVector(publicKeyExp))).require

    val sha = MessageDigest.getInstance("SHA1")
    val digest = sha.digest(encodedKey.toByteArray)

    scodec.codecs.longL(64).decode(BitVector(digest.takeRight(8))).require.value
  }

  val privateKey: PrivateKey = {
    val kf = KeyFactory.getInstance("RSA")
    kf.generatePrivate(new PKCS8EncodedKeySpec(privateKeyBytes))
  }

  val publicKey: PublicKey = {
    val kf = KeyFactory.getInstance("RSA")
    kf.generatePublic(new RSAPublicKeySpec(
      new java.math.BigInteger(publicKeyMod), new java.math.BigInteger(publicKeyExp)))
  }
}

object TelegramRsa {

  // key pair for our protocol
  val key = TelegramRsa(
    publicKeyMod = toArray("00E19E4F19A12F916226ACADEDF5704A4E5054E897F16C173E392AFDE0B371079D5CB26F5CFBE1D0C6C232944CE35EDB047AB32AA3ACF1E6DF33AAA37E614EC57B74BF50EF4C68EC0F2EB3014526A0E2CE80F8B3C567E9B5A7D61D382BA62E8E79EE66C305196DED5C82F66F7E32F03FCBF86D0D7C52179CBD64E45CE6CE87709BF784826285FD8CBB28A11793C94E1240A0993672DD62B1E9AD1818E4E53C98EC0E800C3034E63D1741FF7C2B09050F325DDC49D9DAD308AE2F46D5662A2F55A7AD067794A59DB74D6A3AB8A43E34610A7597D8BC1989E83D0590D0F1E9DFAED20BB09A3DC448AE7AE7A899FCFF54FC28CABCE34055266D735F4ADE6131465B59"),
    publicKeyExp = toArray("00010001"),
    privateKeyBytes = toArray("308204BE020100300D06092A864886F70D0101010500048204A8308204A40201000282010100E19E4F19A12F916226ACADEDF5704A4E5054E897F16C173E392AFDE0B371079D5CB26F5CFBE1D0C6C232944CE35EDB047AB32AA3ACF1E6DF33AAA37E614EC57B74BF50EF4C68EC0F2EB3014526A0E2CE80F8B3C567E9B5A7D61D382BA62E8E79EE66C305196DED5C82F66F7E32F03FCBF86D0D7C52179CBD64E45CE6CE87709BF784826285FD8CBB28A11793C94E1240A0993672DD62B1E9AD1818E4E53C98EC0E800C3034E63D1741FF7C2B09050F325DDC49D9DAD308AE2F46D5662A2F55A7AD067794A59DB74D6A3AB8A43E34610A7597D8BC1989E83D0590D0F1E9DFAED20BB09A3DC448AE7AE7A899FCFF54FC28CABCE34055266D735F4ADE6131465B5902030100010282010038A9747E204FFCF824745B9E1674E40475024E03D2DAED9F6FE60F2A7E86557E3CC8875557E0E778F34E969614C83EC30A39B2ECB6436E5301FBC9E1B4787EFA3960CEE7BA4DE37310AC5E164AD43F01D3BC2211E2BDFC24318ED70B8749CBF86D5A1B824D57A13409A3F06E4646B60EF8CE1283F56DFEAC460960178B28D2ABAFFB39AD58A41E417587C49CA1BF99482D8EFB1212C75A445CB87F37B62E29527D7375DB03FCD78A3EADD0297E31DA75196FC4F84ABAAA61EBD6D929268442521B0A8B3035C296B942E23163C1C7BA5113AA96F79FEEA3A1A324269308FDFA7657026536EF7256918B45A36ED6153F106386174EDE944C5DD1AEF284513698CD02818100FEC8CC196EA6415CA0EA5A30722ADA69AFE70D295271CC7FE910DB8695D7640AC70F2F781AA779D6A0B9C2684F53120AAAACBED51AE3058FCC86CEC50A39EF714B6051A451CA851D085570605A4E7E239BD78F90B20BBF5E1EACA3EF91177E864CCF4415016B157D1B51FC5A48D79A5B6F822489A1C6F2E67743C77EA49476D302818100E2B1E32A364135A9A8876052CD1415742120C526AC67F9AF26C4184CEA3050D9E5006B4327EB4EF0963278F570D5FC5CD15CB477EE2A02B485EBBB6946B25D6B3A45B20D1E4ABC2B49702076BBA320BF285587BD3903924646A8CBBB996C621026D49436B7DD652B000156BFE23DC7BF594B1839F600B9CE4F2F23271D6CA1A302818100E31BB5E2CDA0E10E6259C3BEFF65777F51CED10A8E74E5E6F6A792272B95ED9535CF316F0BC35175A19B33D1AB33CF1736FFF8B318DE586CCFD132AAACECEBA4BF9DC1E88907CF140C03ACC2167D752EE4918765616FDB4B58686750FAB248940A0F8F0E724F33BE6B05EFBDC2C47CD1185A979B1F5BA9D509669F8321CD3D050281806F246DCE6D492D491FD2377C81053EBB6FDE842A40CEBD508D3E08F7F4BD79764ADB18BB951FBDD5209E60455D6BDC4D996BCD231B86474B407961A9ECBA5828D12A08707C10820EEAF369472D197E5D9A25CCE60DC4DD7B4CFB46DF9409DA4E36EB743B1B8C1524AEDCF92E1C7AD3AAD1D98A68285F14B9BC82CCC6499BCFE702818100B3C2286947D73953F015A75A334B3C3305F801A7F92884FCE96A57C1B07E9735CE51D95AD8C32A7F62F5B43B341286810F6768BF9B9B58C36D71FBC53CA79F8B392D976A81AC98E6406132E480D5AC238292B3AEF8E46F1CE5842546C34D6534F3E0815E90F7D531EFC7547944988A1CC1C48A7562576F32BEA2238797D4139F")
  )

  private def toArray(s: String): Array[Byte] = s.grouped(2).map(Integer.parseInt(_, 16).toByte).toArray
}
